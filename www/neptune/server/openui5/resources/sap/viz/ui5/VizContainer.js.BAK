/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.viz.ui5.VizContainer");jQuery.sap.require("sap.viz.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.viz.ui5.VizContainer",{metadata:{publicMethods:["vizUpdate","vizSelection","save","load"],library:"sap.viz",properties:{"uiConfig":{type:"object",group:"Misc",defaultValue:null},"vizType":{type:"string",group:"Misc",defaultValue:null},"vizCss":{type:"string",group:"Misc",defaultValue:null},"vizProperties":{type:"object",group:"Misc",defaultValue:null},"enableMorphing":{type:"boolean",group:"Misc",defaultValue:null},"width":{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:null},"height":{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:null}},aggregations:{"vizData":{type:"sap.viz.ui5.data.Dataset",multiple:false},"analysisObjectsForPicker":{type:"sap.viz.ui5.vizcontainer.common.feeds.AnalysisObject",multiple:true,singularName:"analysisObjectsForPicker"},"feeds":{type:"sap.viz.ui5.vizcontainer.common.feeds.FeedItem",multiple:true,singularName:"feed"}},events:{"feedsChanged":{},"vizTypeChanged":{},"vizDefinitionChanged":{},"selectData":{},"deselectData":{},"showTooltip":{},"hideTooltip":{},"initialized":{}}}});sap.viz.ui5.VizContainer.M_EVENTS={'feedsChanged':'feedsChanged','vizTypeChanged':'vizTypeChanged','vizDefinitionChanged':'vizDefinitionChanged','selectData':'selectData','deselectData':'deselectData','showTooltip':'showTooltip','hideTooltip':'hideTooltip','initialized':'initialized'};jQuery.sap.require("sap.viz.ui5.vizcontainer.common.feeds.AnalysisObject");jQuery.sap.require("sap.viz.ui5.vizcontainer.common.feeds.FeedItem");
sap.viz.ui5.VizContainer.prototype._renderContainer=function(){if(!this._app$){this._createChildren()}else{this._app$.appendTo(this.getDomRef());var o={};if(this._requestedOptions){if(this._requestedOptions.css){o.css=this._requestedOptions.css}if(this._requestedOptions.properties){o.properties=this._requestedOptions.properties}this._requestedOptions=null}o.data=this._getFakedDataInstance(this.getVizData(),this.getAggregation('feeds'));o.feeds=this._getFeedInstances(this.getAggregation('feeds'));this._vizFrame.vizUpdate(o)}if(this._vizBuilder){var a=sap.viz.ui5.vizcontainer.common.feeds.AnalysisObject.toInstances(this.getAnalysisObjectsForPicker());this._vizBuilder.analysisObjectsForPicker(a)}this._validateSize()};
sap.viz.ui5.VizContainer.prototype.init=function(){sap.viz._initializeVIZ();this._uiConfig={'layout':'horizontal','enableMorphing':true};this._clearVariables()};
sap.viz.ui5.VizContainer.prototype.exit=function(){this._clearVariables();this.setVizData(null);if(this._vizFrame){this._vizFrame.destroy();this._vizFrame=null}if(this._vizBuilder){this._vizBuilder.destroy();this._vizBuilder=null}if(this._switchBar){this._switchBar.destroy();this._switchBar=null}};
sap.viz.ui5.VizContainer.prototype._clearVariables=function(){this._app$=null;this._vizFrame$=null;this._vizBuilder$=null;this._switchBar$=null;this._clearRequestedProperties()};
sap.viz.ui5.VizContainer.prototype._clearRequestedProperties=function(){this._requestedVizType='viz/column';this._requestedVizCss=null;this._requestedVizProperties=null;this._requestedOptions=null};
sap.viz.ui5.VizContainer.prototype.onBeforeRendering=function(){};
sap.viz.ui5.VizContainer.prototype.onAfterRendering=function(){this._renderContainer()};
sap.viz.ui5.VizContainer.prototype.getUiConfig=function(){return this._uiConfig};
sap.viz.ui5.VizContainer.prototype.setUiConfig=function(u){if(this._app$){return}u=u||{};if(u.layout==='vertical'||u.layout==='horizontal'){this._uiConfig.layout=u.layout}this._uiConfig.enableMorphing=u.enableMorphing!==false};
sap.viz.ui5.VizContainer.prototype.getFeeds=function(){var f=[];if(this._vizFrame&&this._vizFrame.feeds()){f=sap.viz.ui5.vizcontainer.common.feeds.FeedItem.toFeeds(this._vizFrame.feeds())}else{f=this.getAggregation('feeds')}this._updateFeedsByAAIndex(f);return f};
sap.viz.ui5.VizContainer.prototype.getVizType=function(){if(this._vizFrame){return this._vizFrame.vizType()}else{return this._requestedVizType}};
sap.viz.ui5.VizContainer.prototype.setVizType=function(v){if(this._vizFrame){this._vizFrame.vizType(v)}else{this._requestedVizType=v}return this};
sap.viz.ui5.VizContainer.prototype.getVizCss=function(){if(this._vizFrame){return this._vizFrame.vizCss()}else{return this._requestedVizCss}};
sap.viz.ui5.VizContainer.prototype.setVizCss=function(v){if(this._vizFrame){this._vizFrame.vizCss(v)}else{this._requestedVizCss=v}return this};
sap.viz.ui5.VizContainer.prototype.getVizProperties=function(){if(this._vizFrame){return this._vizFrame.vizProperties()}else{return this._requestedVizProperties}};
sap.viz.ui5.VizContainer.prototype.setVizProperties=function(v){if(this._vizFrame){this._vizFrame.vizProperties(v)}else{this._requestedVizProperties=v}return this};
sap.viz.ui5.VizContainer.prototype.getEnableMorphing=function(){if(this._vizFrame){return this._vizFrame.enableMorphing()}else{return this._uiConfig.enableMorphing}};
sap.viz.ui5.VizContainer.prototype.setEnableMorphing=function(e){if(this._vizFrame){this._vizFrame.enableMorphing(e)}else{this._uiConfig.enableMorphing=e}return this};
sap.viz.ui5.VizContainer.prototype.vizSelection=function(p,a){if(this._vizFrame){var r=this._vizFrame.vizSelection.apply(this._vizFrame,arguments);if(r===this._vizFrame){r=this}return r}else{return null}};
sap.viz.ui5.VizContainer.prototype.vizUpdate=function(o){if(this._vizFrame){if(o.data||o.feeds){this._requestedOptions=this._requestedOptions||{}}if(this._requestedOptions){var r=this._requestedOptions;r.css=r.css||o.css;r.properties=r.properties||o.properties;if(o.data){this.setVizData(o.data)}if(o.feeds){this._setFeeds(o.feeds)}}else{this._vizFrame.vizUpdate(o)}}};
sap.viz.ui5.VizContainer.prototype.save=function(){var j={};if(this._vizFrame){j.vizFrame=this._vizFrame.save()}if(this._vizBuilder){j.vizBuilder=this._vizBuilder.save()}if(this._switchBar){j.switchBar=this._switchBar.save()}return j};
sap.viz.ui5.VizContainer.prototype.load=function(j){if(this._vizFrame&&j.vizFrame){this._vizFrame.load(j.vizFrame)}if(this._vizBuilder&&j.vizBuilder){this._vizBuilder.load(j.vizBuilder)}if(this._switchBar&&j.switchBar){this._switchBar.load(j.switchBar)}};
sap.viz.ui5.VizContainer.prototype._setFeeds=function(f){this.destroyFeeds();if(f&&f.length){for(var i=0;i<f.length;i++){this.addFeed(f[i])}}return this};
sap.viz.ui5.VizContainer.prototype._setAnalysisObjectsForPicker=function(a){this.destroyAnalysisObjectsForPicker();if(a&&a.length){for(var i=0;i<a.length;i++){this.addAnalysisObjectsForPicker(a[i])}}return this};
sap.viz.ui5.VizContainer.prototype._getFeedInstances=function(f){if(f){return sap.viz.ui5.vizcontainer.common.feeds.FeedItem.toInstances(f)}else{return[]}};
sap.viz.ui5.VizContainer.prototype._getDataInstance=function(v){if(v){return v.getVIZDataset()}else{return null}};
sap.viz.ui5.VizContainer.prototype._getFakedDataInstance=function(v,f){var d=this._getDataInstance(v);if(d){var a=new sap.viz.controls.services.FakeDataService(this.getVizType(),JSON.parse(JSON.stringify(d.data())),this._getFeedInstances(f));d=new sap.viz.api.data.CrosstableDataset();d.data(a.getVizDataset());return d}else{return null}};
sap.viz.ui5.VizContainer.CSSConst=(function(){var C={};C.PREFIX="viz-controls-";C.COMMON_PREFIX=C.PREFIX+"common-";C.SWITCHBAR_PREFIX=C.PREFIX+"switchbar-";C.FEEDINGPANEL_PREFIX=C.PREFIX+"feeding-";C.VIZDATAPICKER_PREFIX=C.PREFIX+"datapicker-";C.FRAME_PREFIX=C.PREFIX+"frame-";C.BUILDER_PREFIX=C.PREFIX+"builder-";C.TRELLIS_PREFIX=C.PREFIX+"trellis-";C.MAPBUILDER_PREFIX=C.PREFIX+"mapbuilder-";C.CHART_PREFIX=C.PREFIX+"chart-";C.FILTERBAR_PREFIX=C.PREFIX+"filterbar-";C.FEEDINGSHELF_PREFIX=C.COMMON_PREFIX+"feeding-";return C})();
sap.viz.ui5.VizContainer.prototype._genSwitchGroups=function(){var L=sap.viz.controls.common.managers.LangManager;var s=[{"name":L.get("VIZ_SWITCHBAR_COLUMN_CHARTS"),"types":[{"id":"viz/column"},{"id":"viz/stacked_column"},{"id":"viz/dual_column"}]},{"name":L.get("VIZ_SWITCHBAR_LINE_CHARTS"),"types":[{"id":"viz/line"},{"id":"viz/area"},{"id":"viz/combination"},{"id":"viz/dual_line"},{"id":"viz/dual_combination"}]},{"name":L.get("VIZ_SWITCHBAR_PIE_CHARTS"),"types":[{"id":"viz/pie"},{"id":"viz/donut"}]},{"name":L.get("VIZ_SWITCHBAR_SCATTER_CHARTS"),"types":[{"id":"viz/scatter"},{"id":"viz/bubble"}]},{"name":L.get("VIZ_SWITCHBAR_MAP_CHARTS"),"types":[{"id":"viz/heatmap"},{"id":"viz/treemap"}]}];return s};
sap.viz.ui5.VizContainer.prototype._createVizFrame=function(d){var V=sap.viz.controls.frame.VizFrame;var G=sap.viz.controls.common.config.GlobalConfig;var v=G.defaultUIConfig(G.DEFAULT_UICONFIG_TYPE_FRAME);v.enableFilterMenu=false;v.enableFilterBar=false;v.enableSettingButton=false;v.enableFullScreenButton=false;v.controls.chart.enableMorphing=this._uiConfig.enableMorphing;v.controls.chart.enableTrellis=false;v.controls.contextMenu.menu=[["direction","stacking"],["legend","datalabels"]];var a=new V(d,v);a.addEventListener('feedsChanged',jQuery.proxy(function(e){this._setFeeds(this.getFeeds());this.fireEvent("feedsChanged",{'feeds':this.getFeeds()})},this));a.addEventListener('vizTypeChanged',jQuery.proxy(function(e){this.fireEvent("vizTypeChanged")},this));a.addEventListener('vizDefinitionChanged',jQuery.proxy(function(e){this.fireEvent("vizDefinitionChanged")},this));a.vizOn('selectData',jQuery.proxy(function(e){this.fireEvent("selectData",e)},this));a.vizOn('deselectData',jQuery.proxy(function(e){this.fireEvent("deselectData",e)},this));a.vizOn('showTooltip',jQuery.proxy(function(e){this.fireEvent("showTooltip",e)},this));a.vizOn('hideTooltip',jQuery.proxy(function(e){this.fireEvent("hideTooltip",e)},this));a.vizOn('initialized',jQuery.proxy(function(e){this.fireEvent("initialized",e)},this));var o=a.getDefaultIncompleteOptions(this.getVizType());var f=this.getAggregation('feeds');if(f){o.feeds=this._getFeedInstances(f)}var b=this._getFakedDataInstance(this.getVizData(),f);if(b){o.data=b}if(this.getVizCss()){o.css=this.getVizCss()}if(this.getVizProperties()){o.properties=this.getVizProperties()}this._clearRequestedProperties();a.createViz(o);return a};
sap.viz.ui5.VizContainer.prototype._updateFeedsByAAIndex=function(f){var v=sap.viz.api.manifest.Viz.get(this.getVizType())[0];if(v&&v.allFeeds()){var a=v.allFeeds();var b={};for(var i=0;i<a.length;i++){b[a[i].id]=a[i]}f.sort(function(c,d){var e=b[c.getUid()];var g=b[d.getUid()];var p=e.aaIndex?e.aaIndex:e.aaIndex+1000;var h=g.aaIndex?g.aaIndex:g.aaIndex+1000;return p-h})}};
sap.viz.ui5.VizContainer.prototype._createChildren=function(){var C=sap.viz.ui5.VizContainer.CSSConst;var c='ui5-viz-container';var _=function(p,b){var d=document.createElement('div');var e=jQuery(d);if(b){e.addClass(b)}if(p){e.appendTo(p)}return e};var G=sap.viz.controls.common.config.GlobalConfig;G.defaultAssetsRoot(jQuery.sap.getModulePath('sap.viz.ui5.vizcontainer.libs','/"'));var V=sap.viz.controls.builder.VizBuilder;var S=sap.viz.controls.switchbar.SwitchBar;var a=this._app$=_(this.getDomRef(),c+'-app');jQuery(a).attr("data-sap-ui-preserve",true);this._vizFrame$=_(a,c+'-app-viz-frame');this._vizFrame=this._createVizFrame(this._vizFrame$[0]);if(this._uiConfig.layout==='horizontal'){var v=G.defaultUIConfig(G.DEFAULT_UICONFIG_TYPE_BUILDER);v.controls.feedingPanel.enableTrellis=false;v.controls.switchBar.groups=this._genSwitchGroups();this._vizBuilder$=_(a,c+'-app-viz-builder');this._vizBuilder=new V(this._vizBuilder$[0],v);this._vizBuilder.connect(this._vizFrame.vizUid());this._vSplitter$=_(a,c+'-app-vertical-splitter')}else if(this._uiConfig.layout==='vertical'){var s=G.defaultUIConfig(G.DEFAULT_UICONFIG_TYPE_SWITCHBAR);s.groups=this._genSwitchGroups();this._switchBar$=_(a,c+'-app-switch-bar');this._switchBar=new S(this._switchBar$[0],s);this._switchBar.connect(this._vizFrame.vizUid())}return this};
sap.viz.ui5.VizContainer.prototype._validateSize=function(){var s={'width':this.$().width(),'height':this.$().height()};if(this._uiConfig.layout==='horizontal'){this._app$.css({'min-width':'560px','min-height':'601px'})}else if(this._uiConfig.layout==='vertical'){this._app$.css({'min-width':'300px','min-height':'654px'})}this.$().css({'overflow':'hidden'});var a={'width':this._app$.width(),'height':this._app$.height()};if(this._uiConfig.layout==='horizontal'){var b=this._vizBuilder$.width();this._vizFrame.size({'width':a.width-b,'height':a.height});this._vizBuilder.size({'width':b,'height':a.height-1});this._vizFrame$.css({'left':'0px','top':'0px'});this._vizBuilder$.css({'left':a.width-b+'px','top':'0px'});this._vSplitter$.css({'left':a.width-b+'px','top':'0px','height':a.height+'px'})}else if(this._uiConfig.layout==='vertical'){var c=this._switchBar$.height();this._vizFrame.size({'width':a.width,'height':a.height-c});this._switchBar.size({'width':a.width,'height':c});this._vizFrame$.css({'left':'0px','top':c+'px'});this._switchBar$.css({'left':'0px','top':'0px'})}this.$().css({'overflow':'auto'})};
